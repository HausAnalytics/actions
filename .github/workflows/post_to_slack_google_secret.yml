name: Post to slack with token from google secrets

on:
  workflow_call:
    inputs:
      CHANNEL_ID:
        required: true
        type: string
        description: Channel ID for slack message to be sent to
      TEXT:
        required: true
        type: string
        description: Simple text message sent with Slack message
      GOOGLE_CREDENTIALS:
        required: true
        type: string
        description: Encoded JSON string that represent google credential service account that has access to the secret defined by GOOGLE_SECRET_KEY_FOR_SLACK_TOKEN
      GOOGLE_SECRET_KEY_FOR_SLACK_TOKEN:
        required: true
        type: string
        description: Fully qualified secret key [project_id]/[key_name]
      BLOCKS:
        required: false
        type: string
        description: Encoded JSON string outlined here https://api.slack.com/reference/block-kit/blocks 
jobs:
  post_to_slack_google_secret:
    timeout-minutes: 1
    runs-on: ubuntu-latest
    steps:
    # Authorize with passed in GOOGLE CREDENTIAL JSON
    - name: Auth with GCP
      uses: 'google-github-actions/auth@v0'
      with:
        credentials_json: '${{ github.event.inputs.GOOGLE_CREDENTIALS }}'
    # Retrieve secret from Google Secrets using
    - name: Fetch secret from Google Secrets to deploy message using slack
      id: google_secret
      uses: 'google-github-actions/get-secretmanager-secrets@v0'
      with:
        secrets: |-
            slack_token:${{ github.event.inputs.GOOGLE_SECRET_KEY_FOR_SLACK_TOKEN }}
    # Use slack token that is retrieved from google secrets to post to slack
    - name: Post to slack channel with only text
      if: "github.event.inputs.BLOCKS == ''"
      uses: slackapi/slack-github-action@v1.21.0
      with:
        channel-id: ${{ github.event.inputs.CHANNEL_ID }}
        slack-message: ${{ github.event.inputs.TEXT }}
      env:
        SLACK_BOT_TOKEN: '${{ steps.google_secret.outputs.slack_token }}'
    - name: Post to slack channel with blocks
      if: "github.event.inputs.BLOCKS != ''"
      uses: slackapi/slack-github-action@v1.21.0
      with:
        channel-id: ${{ github.event.inputs.CHANNEL_ID }}
        slack-message: ${{ github.event.inputs.TEXT }}
        payload: |
          {
            "text": "${{ github.event.inputs.TEXT }}",
            "blocks": ${{ github.event.inputs.BLOCKS }}
          }
      env:
        SLACK_BOT_TOKEN: '${{ steps.google_secret.outputs.slack_token }}'